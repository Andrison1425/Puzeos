
<div class="fondo"></div>

<ion-header>
  <ion-toolbar style=" padding:0;" color="primary">
    <ion-back-button
      slot="start"
      defaultHref="/chat"
      text=""
      mode="md"
    ></ion-back-button>

    <span class="loc_contac-info" (click)="openModal()">
      <img
        [src]="imgPath"
        class="chat__img "
      >
      <h6>{{user?.data.userName}}</h6>
    </span>

    <ion-button slot="end" mode="ios" (click)="presentPopover($event)">
      <ion-icon name="ellipsis-vertical-sharp"></ion-icon>
    </ion-button>
  </ion-toolbar>

</ion-header>
<div class="loc__espacio"></div>

<ion-content class="loc__content" #content (scroll)="scrollEvent($event)">

  <ion-infinite-scroll threshold="100px" position="top" (ionInfinite)="loadData($event)">
    <ion-infinite-scroll-content
      loadingSpinner="bubbles"
      loadingText="Loading more data...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <app-scroll-bottom
    [content]="content"
    *ngIf="showScrollButton"
  ></app-scroll-bottom>

  <span *ngFor="let mensaje of mensajes; trackBy: trackByFn; last as isLast" class="message-chat">

    <app-item-message
      *ngIf="mensaje.type!=='text'"
      [message]="mensaje"
      [userName]="userName"
      [last]="isLast"
      [dbMessage]="dbMessages"
      [content]="content"
      [searchMessage]="routeQuery.search"
      [idSearch]="routeQuery.id"
    ></app-item-message>
    <app-item-message
      *ngIf="mensaje.type==='text'"
      [message]="mensaje"
      [userName]="userName"
      [last]="isLast"
      [content]="content"
      [searchMessage]="routeQuery.search"
      [idSearch]="routeQuery.id"
      [idChat]="idChat"
    ></app-item-message>
  </span>
</ion-content>

<ion-footer>
  <div *ngIf="replyMessage">
    <div class="loc__reply">
      <ion-icon name="arrow-redo" color="primary"></ion-icon>
      <span class="truncar">
        <p class="userName">
          {{replyMessage.user}}
        </p>
        <span >
          {{replyMessage.message}}
        </span>
      </span>
      <div class="loc__delete-reply" (click)="deleteReply()">
        <ion-icon name="close"></ion-icon>
      </div>
    </div>
  </div>
  <form [formGroup]="miFormulario" style="display: contents;" *ngIf="!blockChat">
    <ion-toolbar class="loc_toolbar d-flex">
      <div
        class="loc__info-grabar"
        *ngIf="tooglePress===true"
      >
        <ion-icon name="radio-button-on-outline" class="loc__icon-grabando"></ion-icon>
        <p>{{tiempoGrabacion}}</p>

        <ion-icon name="chevron-back-outline"></ion-icon>
        <p>
          {{'ChatPage.Swipe' | translate}}
        </p>
      </div>
      <ion-icon
        [name]="showEmojiPicker?'keypad':'happy-sharp'"
        slot="start"
        color="secondary"
        class="loc_icon-footer"
        (click)="toogleEmojiPicker()"
        *ngIf="tooglePress===false"
      ></ion-icon>

      <ion-textarea
        [placeholder]="'ChatPage.Message' | translate"
        class="chat__input"
        formControlName="mensaje"
        auto-grow="true"
        spellcheck="true"
        rows="1"
        (click)="resetPosEmoji=true"
        maxlength="1000"
        *ngIf="tooglePress===false"
      ></ion-textarea>

      <ion-buttons
        slot="end"
        [class]="tooglePress?'footer-grabando loc__btns-footer':'loc__btns-footer'"
        *ngIf="miFormulario.invalid;else btnEnviar"
      >
         <app-file-selector
          *ngIf="tooglePress===false"
          [userName]="userName"
          [idChat]="idChat"
        ></app-file-selector>

          <ion-item-sliding (ionDrag)="handleSlide($event)" #sliding>
            <ion-item >
              <ion-label>
                <ion-button
                  [class]="tooglePress?'loc__press':''"
                  (mousedown)="recorder()"
                  (mouseup)="stop()"
                  (touchend)="stop()"
                  (touchstart)="recorder()"
                >
                  <ion-icon
                    slot="icon-only"
                    name="mic-sharp"
                    color="secondary"
                    class="loc_icon-footer"
                  ></ion-icon>
                </ion-button>
              </ion-label>
            </ion-item>

            <ion-item-options side="end">
              <ion-item-option expandable [class]="tooglePress?'grabando':''">

              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        </ion-buttons>

        <ng-template #btnEnviar>
          <ion-buttons slot="end" class="loc__btns-footer">
            <ion-icon
              name="send"
              color="secondary"
              class="loc_icon-footer"
              (click)="agregarMensaje()"
            ></ion-icon>
          </ion-buttons>
        </ng-template>

    </ion-toolbar>
  </form>
  <ion-text *ngIf="blockChat">
    {{'ChatPage.DeleteChatMessage' | translate:{ value: user?.data.userName} }}
  </ion-text>
</ion-footer>

<audio src="../../../../assets/sounds/soundMessage.mp3" class="sendMessageSound"></audio>

<ion-footer class="emojiContainer" [style.minHeight]="showEmojiPicker?'300px':'0px'"> <!--Show/Hide emoji picker. Don't use *ngIf because the component will be created again and again and cause performance issue-->
  <emoji-picker (onEmojiSelect)="addEmoji($event)" *ngIf="showEmojiPicker || showEmojiPickerCont!==0"></emoji-picker>
</ion-footer>
